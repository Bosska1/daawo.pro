
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stream Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #000;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    
    #playerContainer {
      position: relative;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background-color: #000;
    }
    
    iframe {
      width: 100%;
      height: 100%;
      border: none;
      background-color: #000;
    }
    
    .error-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 10;
    }
    
    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
      color: #f43f5e;
    }
    
    .error-message {
      font-size: 18px;
      margin-bottom: 16px;
      text-align: center;
      max-width: 80%;
    }
    
    .error-button {
      background: linear-gradient(to right, #3b82f6, #38ef7d);
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 10px rgba(56, 239, 125, 0.3);
    }
    
    .error-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(56, 239, 125, 0.4);
    }
    
    .loading-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background-color: #000;
      z-index: 5;
    }
    
    .spinner {
      position: relative;
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
    }
    
    .spinner-ring {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 4px solid rgba(56, 239, 125, 0.1);
      border-radius: 50%;
    }
    
    .spinner-circle {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 4px solid transparent;
      border-top-color: #38ef7d;
      border-right-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .spinner-inner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      color: #38ef7d;
    }
    
    .loading-text {
      font-size: 18px;
      margin-top: 10px;
      color: #fff;
      font-weight: bold;
      background: linear-gradient(to right, #3b82f6, #38ef7d);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .loading-progress {
      font-size: 16px;
      margin-top: 5px;
      color: #9ca3af;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .message {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(to right, rgba(59, 130, 246, 0.8), rgba(56, 239, 125, 0.8));
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 20;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    
    .message.show {
      opacity: 1;
    }
    
    .play-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      background: rgba(56, 239, 125, 0.2);
      border: 2px solid #38ef7d;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 15;
      animation: pulse 2s infinite;
    }
    
    .play-button:before {
      content: '';
      width: 0;
      height: 0;
      border-top: 15px solid transparent;
      border-bottom: 15px solid transparent;
      border-left: 25px solid #38ef7d;
      margin-left: 5px;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(56, 239, 125, 0.4);
      }
      70% {
        box-shadow: 0 0 0 20px rgba(56, 239, 125, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(56, 239, 125, 0);
      }
    }
    
    /* iOS PWA install prompt */
    .pwa-prompt {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(to right, rgba(59, 130, 246, 0.95), rgba(56, 239, 125, 0.95));
      color: white;
      padding: 15px 20px;
      border-radius: 12px;
      font-size: 14px;
      z-index: 30;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      width: 90%;
      max-width: 350px;
      display: none;
    }
    
    .pwa-prompt-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 16px;
    }
    
    .pwa-prompt-content {
      margin-bottom: 12px;
    }
    
    .pwa-prompt-steps {
      background: rgba(255, 255, 255, 0.2);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .pwa-prompt-step {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .pwa-prompt-step:last-child {
      margin-bottom: 0;
    }
    
    .pwa-prompt-step-number {
      background: white;
      color: #3b82f6;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
      margin-right: 8px;
      flex-shrink: 0;
    }
    
    .pwa-prompt-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .pwa-prompt-button {
      background: white;
      color: #3b82f6;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .pwa-prompt-button.secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
  </style>
</head>
<body>
  <div id="playerContainer">
    <!-- Video player will be inserted here -->
    <div id="playButton" class="play-button"></div>
  </div>
  
  <!-- Loading indicator -->
  <div id="loadingContainer" class="loading-container">
    <div class="spinner">
      <div class="spinner-ring"></div>
      <div class="spinner-circle"></div>
      <div class="spinner-inner">▶</div>
    </div>
    <div class="loading-text">Loading your stream...</div>
    <div class="loading-progress" id="loadingProgress">0%</div>
  </div>
  
  <!-- Error display -->
  <div id="errorContainer" class="error-container" style="display: none;">
    <div class="error-icon">⚠️</div>
    <div class="error-message" id="errorMessage">Unable to load the stream</div>
    <button class="error-button" id="retryBtn">Try Again</button>
  </div>
  
  <!-- Message display -->
  <div id="message" class="message"></div>
  
  <!-- iOS PWA Install Prompt -->
  <div id="pwaPrompt" class="pwa-prompt">
    <div class="pwa-prompt-title">Install StreamGoal App</div>
    <div class="pwa-prompt-content">
      Install our app to watch streams without interruptions!
    </div>
    <div class="pwa-prompt-steps">
      <div class="pwa-prompt-step">
        <div class="pwa-prompt-step-number">1</div>
        <div>Tap the Share button</div>
      </div>
      <div class="pwa-prompt-step">
        <div class="pwa-prompt-step-number">2</div>
        <div>Scroll and tap "Add to Home Screen"</div>
      </div>
      <div class="pwa-prompt-step">
        <div class="pwa-prompt-step-number">3</div>
        <div>Tap "Add" to install</div>
      </div>
    </div>
    <div class="pwa-prompt-buttons">
      <button id="pwaLater" class="pwa-prompt-button secondary">Later</button>
      <button id="pwaGotIt" class="pwa-prompt-button">Got it</button>
    </div>
  </div>

  <script>
    // DOM elements
    const playerContainer = document.getElementById('playerContainer');
    const loadingContainer = document.getElementById('loadingContainer');
    const loadingProgress = document.getElementById('loadingProgress');
    const errorContainer = document.getElementById('errorContainer');
    const errorMessage = document.getElementById('errorMessage');
    const retryBtn = document.getElementById('retryBtn');
    const messageEl = document.getElementById('message');
    const playButton = document.getElementById('playButton');
    const pwaPrompt = document.getElementById('pwaPrompt');
    const pwaLater = document.getElementById('pwaLater');
    const pwaGotIt = document.getElementById('pwaGotIt');
    
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    let streamUrl = urlParams.get('url');
    let teamA = urlParams.get('teamA');
    let teamB = urlParams.get('teamB');
    let scoreA = urlParams.get('scoreA');
    let scoreB = urlParams.get('scoreB');
    let teamAFlag = urlParams.get('teamAFlag');
    let teamBFlag = urlParams.get('teamBFlag');
    
    // Fallback stream if the main one fails
    const fallbackStream = 'https://www.youtube.com/embed/live_stream?channel=UCQfwfsi5VrQ8yKZ-UWmAEFg&autoplay=1';
    
    let currentPlayer = null;
    let loadingTimeout = null;
    let progressInterval = null;
    let hlsInstance = null;
    let userInteracted = false;
    let streamAttempts = 0;
    const MAX_ATTEMPTS = 3;
    
    // Check if running as standalone PWA
    const isRunningAsPWA = window.matchMedia('(display-mode: standalone)').matches || 
                          window.navigator.standalone || 
                          document.referrer.includes('android-app://');
    
    // Check if it's iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    
    // Function to add timestamp to URL
    function addTimestamp(url) {
      if (!url) return url;
      
      const timestamp = Date.now();
      const separator = url.includes('?') ? '&' : '?';
      return `${url}${separator}_t=${timestamp}`;
    }
    
    // Function to show loading
    function showLoading() {
      loadingContainer.style.display = 'flex';
      errorContainer.style.display = 'none';
      
      // Clear any existing intervals
      if (progressInterval) clearInterval(progressInterval);
      
      // Animate progress - faster for better perceived performance
      let progress = 0;
      progressInterval = setInterval(() => {
        progress += Math.random() * 25; // Even faster progress
        if (progress >= 99) {
          progress = 99;
          clearInterval(progressInterval);
        }
        loadingProgress.textContent = `${Math.floor(progress)}%`;
      }, 50);
      
      // Set timeout to show error if loading takes too long - shorter timeout
      if (loadingTimeout) clearTimeout(loadingTimeout);
      loadingTimeout = setTimeout(() => {
        if (loadingContainer.style.display !== 'none') {
          showError('Stream is taking too long to load. Please try again.');
          clearInterval(progressInterval);
        }
      }, 5000); // Reduced from 10s to 5s
      
      return progressInterval;
    }
    
    // Function to hide loading
    function hideLoading() {
      loadingContainer.style.display = 'none';
      if (progressInterval) clearInterval(progressInterval);
      if (loadingTimeout) clearTimeout(loadingTimeout);
    }
    
    // Function to show error
    function showError(message) {
      loadingContainer.style.display = 'none';
      errorMessage.textContent = message || 'Unable to load the stream';
      errorContainer.style.display = 'flex';
      
      // Notify parent window
      try {
        window.parent.postMessage('videoError', '*');
      } catch (e) {
        console.error('Error sending message to parent:', e);
      }
      
      // Show PWA prompt for iOS users if not already installed
      if (isIOS && !isRunningAsPWA && !localStorage.getItem('pwa_prompt_dismissed')) {
        setTimeout(() => {
          pwaPrompt.style.display = 'block';
        }, 1000);
      }
    }
    
    // Function to show message
    function showMessage(text) {
      messageEl.textContent = text;
      messageEl.classList.add('show');
      
      setTimeout(() => {
        messageEl.classList.remove('show');
      }, 2000);
    }
    
    // Function to create iframe player
    function createIframePlayer(url) {
      // Remove existing player if any
      if (currentPlayer) {
        if (hlsInstance) {
          hlsInstance.destroy();
          hlsInstance = null;
        }
        playerContainer.removeChild(currentPlayer);
      }
      
      // Create iframe
      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.allowFullscreen = true;
      iframe.allow = 'autoplay; fullscreen; picture-in-picture';
      iframe.setAttribute('frameborder', '0');
      
      // Add iframe to container
      playerContainer.appendChild(iframe);
      currentPlayer = iframe;
      
      // Hide loading after a short delay
      setTimeout(() => {
        hideLoading();
        // Notify parent window
        try {
          window.parent.postMessage('videoPlaying', '*');
        } catch (e) {
          console.error('Error sending message to parent:', e);
        }
      }, 2000);
      
      // Hide play button
      playButton.style.display = 'none';
      
      return iframe;
    }
    
    // Function to create direct video player
    function createVideoPlayer(url) {
      // Remove existing player if any
      if (currentPlayer) {
        if (hlsInstance) {
          hlsInstance.destroy();
          hlsInstance = null;
        }
        playerContainer.removeChild(currentPlayer);
      }
      
      // Create video element
      const video = document.createElement('video');
      video.controls = true; // Use native controls for better compatibility
      video.autoplay = false; // We'll handle autoplay manually
      video.playsInline = true;
      video.muted = true; // Start muted to help with autoplay
      video.setAttribute('playsinline', ''); // For iOS
      video.setAttribute('webkit-playsinline', ''); // For older iOS
      
      // Add video to container
      playerContainer.appendChild(video);
      currentPlayer = video;
      
      // Special handling for Asal Drama streams
      if (url.includes('yow.riix.link/asal/musalsal') || url.includes('asal/drama')) {
        // Try direct playback first
        video.src = url;
        video.onerror = () => {
          console.log("Direct playback failed, trying with fetch");
          
          // If direct playback fails, try to fetch the stream with custom headers
          fetch(url, {
            headers: {
              'User-Agent': 'ExoPlayer',
              'Referer': 'https://streamgoal.app/',
              'Origin': 'https://streamgoal.app'
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.blob();
          })
          .then(blob => {
            const objectUrl = URL.createObjectURL(blob);
            video.src = objectUrl;
            
            video.onloadeddata = () => {
              hideLoading();
              playButton.style.display = 'flex';
            };
            
            video.onerror = () => {
              console.error("Video error after fetch:", video.error);
              showError("Stream error. Please try another source.");
            };
          })
          .catch(error => {
            console.error("Fetch error:", error);
            showError("Network error. Please try again.");
          });
        };
        
        video.onloadeddata = () => {
          hideLoading();
          playButton.style.display = 'flex';
        };
        
        return video;
      }
      
      // Handle HLS streams
      if ((url.includes('.m3u8') || url.includes('/asal/')) && Hls.isSupported()) {
        hlsInstance = new Hls({
          maxBufferLength: 30,
          maxMaxBufferLength: 60,
          startLevel: -1,
          capLevelToPlayerSize: true,
          debug: false,
          xhrSetup: function(xhr, url) {
            // Set custom headers if needed for specific streams
            xhr.setRequestHeader('User-Agent', 'ExoPlayer');
            xhr.setRequestHeader('Referer', 'https://streamgoal.app/');
            xhr.setRequestHeader('Origin', 'https://streamgoal.app');
          }
        });
        
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
          // Show play button instead of auto-playing
          playButton.style.display = 'flex';
          hideLoading();
          
          // Handle play button click
          playButton.onclick = () => {
            userInteracted = true;
            video.play()
              .then(() => {
                playButton.style.display = 'none';
                showMessage('Stream started');
                // Notify parent window
                try {
                  window.parent.postMessage('videoPlaying', '*');
                } catch (e) {
                  console.error('Error sending message to parent:', e);
                }
              })
              .catch(e => {
                console.error('Error playing video:', e);
                showError('Browser blocked autoplay. Please tap again to play.');
              });
          };
          
          // Auto-play if user has interacted
          if (userInteracted) {
            video.play()
              .then(() => {
                playButton.style.display = 'none';
                // Notify parent window
                try {
                  window.parent.postMessage('videoPlaying', '*');
                } catch (e) {
                  console.error('Error sending message to parent:', e);
                }
              })
              .catch(e => {
                console.error('Error playing video:', e);
                // Show play button if autoplay fails
                playButton.style.display = 'flex';
              });
          }
        });
        
        hlsInstance.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            console.error('HLS error:', data);
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                showError('Network error. Please try again.');
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                showError('Media error. Please try again.');
                hlsInstance.recoverMediaError();
                break;
              default:
                showError('Stream error. Please try again.');
                break;
            }
          }
        });
      } else {
        // Direct source for non-HLS streams
        video.src = url;
        
        video.addEventListener('loadeddata', () => {
          hideLoading();
          playButton.style.display = 'flex';
          
          // Notify parent window
          try {
            window.parent.postMessage('videoPlaying', '*');
          } catch (e) {
            console.error('Error sending message to parent:', e);
          }
        });
        
        video.addEventListener('error', () => {
          console.error('Video error:', video.error);
          showError('Stream error. Please try again.');
        });
        
        // Handle play button click
        playButton.onclick = () => {
          userInteracted = true;
          video.play()
            .then(() => {
              playButton.style.display = 'none';
              showMessage('Stream started');
            })
            .catch(e => {
              console.error('Error playing video:', e);
              showError('Browser blocked autoplay. Please tap again to play.');
            });
        };
      }
      
      return video;
    }
    
    // Function to load stream
    function loadStream(url) {
      if (!url) {
        showError('No stream URL provided');
        return;
      }
      
      showLoading();
      streamAttempts++;
      
      // Special handling for the specific URL format
      if (url.includes('yow.riix.link/asal/musalsal/') || url.includes('asal/drama')) {
        // Create direct video player for this specific URL
        createVideoPlayer(url);
        return;
      }
      
      // Determine player type based on URL
      if (url.includes('youtube.com') || url.includes('youtu.be') || url.includes('embed')) {
        createIframePlayer(url);
      } else {
        createVideoPlayer(url);
      }
    }
    
    // Function to retry current source
    function retryCurrentSource() {
      // Add new timestamp to force refresh
      const baseUrl = streamUrl ? streamUrl.split('?')[0] : fallbackStream;
      const refreshedUrl = addTimestamp(baseUrl);
      loadStream(refreshedUrl);
    }
    
    // Function to try alternative source
    function tryAlternativeSource() {
      // If we've tried too many times with the main URL, use fallback
      if (streamAttempts >= MAX_ATTEMPTS) {
        loadStream(fallbackStream);
        return;
      }
      
      // Try with a different approach for the specific URL
      if (streamUrl && streamUrl.includes('yow.riix.link/asal/musalsal/')) {
        // Try a different version of the URL
        const altUrl = streamUrl.replace('yow.riix.link/asal/musalsal/', 'yow.riix.link/asal/drama/');
        loadStream(altUrl);
      } else if (streamUrl && streamUrl.includes('asal/drama')) {
        // Try a different version of the URL
        const altUrl = streamUrl.replace('asal/drama', 'asal/musalsal');
        loadStream(altUrl);
      } else {
        // Just retry with a new timestamp
        retryCurrentSource();
      }
    }
    
    // Start loading the stream
    if (streamUrl) {
      // Add timestamp to avoid caching
      streamUrl = addTimestamp(streamUrl);
      loadStream(streamUrl);
    } else {
      // If no stream URL provided, use fallback stream
      loadStream(fallbackStream);
    }
    
    // Event listeners
    retryBtn.addEventListener('click', function() {
      userInteracted = true;
      retryCurrentSource();
    });
    
    // PWA prompt handlers
    pwaLater.addEventListener('click', function() {
      pwaPrompt.style.display = 'none';
      localStorage.setItem('pwa_prompt_dismissed_temp', 'true');
    });
    
    pwaGotIt.addEventListener('click', function() {
      pwaPrompt.style.display = 'none';
      localStorage.setItem('pwa_prompt_dismissed', 'true');
    });
    
    // Listen for messages from parent window
    window.addEventListener('message', function(event) {
      if (event.data === 'toggleMute' && currentPlayer && currentPlayer.tagName === 'VIDEO') {
        currentPlayer.muted = !currentPlayer.muted;
        showMessage(currentPlayer.muted ? 'Muted' : 'Unmuted');
      }
    });
    
    // Handle clicks on the player to play/pause
    playerContainer.addEventListener('click', function(e) {
      // Don't handle clicks on buttons or controls
      if (e.target.tagName === 'BUTTON' || 
          e.target.closest('.error-container') ||
          e.target === playButton) {
        return;
      }
      
      userInteracted = true;
      
      // If there's an error showing, try again
      if (errorContainer.style.display !== 'none') {
        retryCurrentSource();
        return;
      }
      
      // Toggle play/pause if it's a video
      if (currentPlayer && currentPlayer.tagName === 'VIDEO') {
        if (currentPlayer.paused) {
          currentPlayer.play();
          playButton.style.display = 'none';
        } else {
          currentPlayer.pause();
          playButton.style.display = 'flex';
        }
      }
    });
    
    // Handle user interaction to enable autoplay
    document.addEventListener('click', function() {
      userInteracted = true;
    });
    
    document.addEventListener('touchstart', function() {
      userInteracted = true;
    });
    
    // Check if we should show the PWA prompt for iOS users
    if (isIOS && !isRunningAsPWA && !localStorage.getItem('pwa_prompt_dismissed')) {
      // Show after a delay
      setTimeout(() => {
        pwaPrompt.style.display = 'block';
      }, 3000);
    }
  </script>
</body>
</html>