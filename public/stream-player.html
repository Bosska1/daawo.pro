
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stream Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #000;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    
    #playerContainer {
      position: relative;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background-color: #000;
    }
    
    iframe {
      width: 100%;
      height: 100%;
      border: none;
      background-color: #000;
    }
    
    .error-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 10;
    }
    
    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
      color: #f43f5e;
    }
    
    .error-message {
      font-size: 18px;
      margin-bottom: 16px;
      text-align: center;
      max-width: 80%;
    }
    
    .error-button {
      background: linear-gradient(to right, #3b82f6, #38ef7d);
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 10px rgba(56, 239, 125, 0.3);
    }
    
    .error-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(56, 239, 125, 0.4);
    }
    
    .loading-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background-color: #000;
      z-index: 5;
    }
    
    .spinner {
      position: relative;
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
    }
    
    .spinner-ring {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 4px solid rgba(56, 239, 125, 0.1);
      border-radius: 50%;
    }
    
    .spinner-circle {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 4px solid transparent;
      border-top-color: #38ef7d;
      border-right-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .spinner-inner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      color: #38ef7d;
    }
    
    .loading-text {
      font-size: 18px;
      margin-top: 10px;
      color: #fff;
      font-weight: bold;
      background: linear-gradient(to right, #3b82f6, #38ef7d);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .loading-progress {
      font-size: 16px;
      margin-top: 5px;
      color: #9ca3af;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .message {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(to right, rgba(59, 130, 246, 0.8), rgba(56, 239, 125, 0.8));
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 20;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    
    .message.show {
      opacity: 1;
    }
    
    .play-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      background: rgba(56, 239, 125, 0.2);
      border: 2px solid #38ef7d;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 15;
      animation: pulse 2s infinite;
    }
    
    .play-button:before {
      content: '';
      width: 0;
      height: 0;
      border-top: 15px solid transparent;
      border-bottom: 15px solid transparent;
      border-left: 25px solid #38ef7d;
      margin-left: 5px;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(56, 239, 125, 0.4);
      }
      70% {
        box-shadow: 0 0 0 20px rgba(56, 239, 125, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(56, 239, 125, 0);
      }
    }
    
    .controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      padding: 20px;
      display: flex;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 10;
    }
    
    #playerContainer:hover .controls {
      opacity: 1;
    }
    
    .control-button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }
    
    .control-button svg {
      width: 24px;
      height: 24px;
    }
    
    .progress-bar {
      flex: 1;
      height: 5px;
      background: rgba(255,255,255,0.2);
      border-radius: 5px;
      overflow: hidden;
      cursor: pointer;
      margin: 0 10px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(to right, #3b82f6, #38ef7d);
      width: 0%;
    }
    
    .time {
      color: white;
      font-size: 14px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div id="playerContainer">
    <!-- Video player will be inserted here -->
    <div id="playButton" class="play-button"></div>
  </div>
  
  <!-- Loading indicator -->
  <div id="loadingContainer" class="loading-container">
    <div class="spinner">
      <div class="spinner-ring"></div>
      <div class="spinner-circle"></div>
      <div class="spinner-inner">▶</div>
    </div>
    <div class="loading-text">Loading your stream...</div>
    <div class="loading-progress" id="loadingProgress">0%</div>
  </div>
  
  <!-- Error display -->
  <div id="errorContainer" class="error-container" style="display: none;">
    <div class="error-icon">⚠️</div>
    <div class="error-message" id="errorMessage">Unable to load the stream</div>
    <button class="error-button" id="retryBtn">Try Again</button>
    <button class="error-button" id="nextSourceBtn" style="margin-top: 10px;">Try Another Source</button>
  </div>
  
  <!-- Message display -->
  <div id="message" class="message"></div>

  <script>
    // DOM elements
    const playerContainer = document.getElementById('playerContainer');
    const loadingContainer = document.getElementById('loadingContainer');
    const loadingProgress = document.getElementById('loadingProgress');
    const errorContainer = document.getElementById('errorContainer');
    const errorMessage = document.getElementById('errorMessage');
    const retryBtn = document.getElementById('retryBtn');
    const nextSourceBtn = document.getElementById('nextSourceBtn');
    const messageEl = document.getElementById('message');
    const playButton = document.getElementById('playButton');
    
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    let streamUrl = urlParams.get('url');
    let teamA = urlParams.get('teamA');
    let teamB = urlParams.get('teamB');
    let scoreA = urlParams.get('scoreA');
    let scoreB = urlParams.get('scoreB');
    let teamAFlag = urlParams.get('teamAFlag');
    let teamBFlag = urlParams.get('teamBFlag');
    
    // Fallback streams if the main one fails
    const fallbackStreams = [
      'https://www.youtube.com/embed/live_stream?channel=UCQfwfsi5VrQ8yKZ-UWmAEFg&autoplay=1',
      'https://www.youtube.com/embed/live_stream?channel=UCNL1OpuVr6OU-FF9RWVFJFw&autoplay=1',
      'https://www.youtube.com/embed/live_stream?channel=UCt4t-jeY85JegMlZ-E5UWtA&autoplay=1'
    ];
    
    let currentSourceIndex = 0;
    let sources = [];
    let currentPlayer = null;
    let loadingTimeout = null;
    let progressInterval = null;
    let hlsInstance = null;
    let userInteracted = false;
    
    // Function to add timestamp to URL
    function addTimestamp(url) {
      if (!url) return url;
      
      const timestamp = Date.now();
      const separator = url.includes('?') ? '&' : '?';
      return `${url}${separator}_t=${timestamp}`;
    }
    
    // Function to show loading
    function showLoading() {
      loadingContainer.style.display = 'flex';
      errorContainer.style.display = 'none';
      
      // Clear any existing intervals
      if (progressInterval) clearInterval(progressInterval);
      
      // Animate progress - faster for better perceived performance
      let progress = 0;
      progressInterval = setInterval(() => {
        progress += Math.random() * 25; // Even faster progress
        if (progress >= 99) {
          progress = 99;
          clearInterval(progressInterval);
        }
        loadingProgress.textContent = `${Math.floor(progress)}%`;
      }, 50);
      
      // Set timeout to show error if loading takes too long - shorter timeout
      if (loadingTimeout) clearTimeout(loadingTimeout);
      loadingTimeout = setTimeout(() => {
        if (loadingContainer.style.display !== 'none') {
          showError('Stream is taking too long to load. Trying another source...');
          clearInterval(progressInterval);
          // Auto-try next source
          setTimeout(tryNextSource, 1000);
        }
      }, 5000); // Reduced from 10s to 5s
      
      return progressInterval;
    }
    
    // Function to hide loading
    function hideLoading() {
      loadingContainer.style.display = 'none';
      if (progressInterval) clearInterval(progressInterval);
      if (loadingTimeout) clearTimeout(loadingTimeout);
    }
    
    // Function to show error
    function showError(message) {
      loadingContainer.style.display = 'none';
      errorMessage.textContent = message || 'Unable to load the stream';
      errorContainer.style.display = 'flex';
      
      // Notify parent window
      try {
        window.parent.postMessage('videoError', '*');
      } catch (e) {
        console.error('Error sending message to parent:', e);
      }
    }
    
    // Function to show message
    function showMessage(text) {
      messageEl.textContent = text;
      messageEl.classList.add('show');
      
      setTimeout(() => {
        messageEl.classList.remove('show');
      }, 2000);
    }
    
    // Function to create iframe player
    function createIframePlayer(url) {
      // Remove existing player if any
      if (currentPlayer) {
        if (hlsInstance) {
          hlsInstance.destroy();
          hlsInstance = null;
        }
        playerContainer.removeChild(currentPlayer);
      }
      
      // Create iframe
      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.allowFullscreen = true;
      iframe.allow = 'autoplay; fullscreen; picture-in-picture';
      iframe.setAttribute('frameborder', '0');
      
      // Add iframe to container
      playerContainer.appendChild(iframe);
      currentPlayer = iframe;
      
      // Hide loading after a short delay
      setTimeout(() => {
        hideLoading();
        // Notify parent window
        try {
          window.parent.postMessage('videoPlaying', '*');
        } catch (e) {
          console.error('Error sending message to parent:', e);
        }
      }, 2000);
      
      // Hide play button
      playButton.style.display = 'none';
      
      return iframe;
    }
    
    // Function to create direct video player
    function createVideoPlayer(url) {
      // Remove existing player if any
      if (currentPlayer) {
        if (hlsInstance) {
          hlsInstance.destroy();
          hlsInstance = null;
        }
        playerContainer.removeChild(currentPlayer);
      }
      
      // Create video element
      const video = document.createElement('video');
      video.controls = false; // We'll use our own controls
      video.autoplay = false; // We'll handle autoplay manually
      video.playsInline = true;
      video.muted = true; // Start muted to help with autoplay
      video.setAttribute('playsinline', ''); // For iOS
      video.setAttribute('webkit-playsinline', ''); // For older iOS
      
      // Add video to container
      playerContainer.appendChild(video);
      currentPlayer = video;
      
      // Create custom controls
      const controls = document.createElement('div');
      controls.className = 'controls';
      controls.innerHTML = `
        <button class="control-button play-pause">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
        </button>
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
        <div class="time">00:00</div>
      `;
      playerContainer.appendChild(controls);
      
      // Handle HLS streams
      if (url.includes('.m3u8') && Hls.isSupported()) {
        hlsInstance = new Hls({
          maxBufferLength: 30,
          maxMaxBufferLength: 60,
          startLevel: -1,
          capLevelToPlayerSize: true,
          debug: false
        });
        
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
          // Show play button instead of auto-playing
          playButton.style.display = 'flex';
          hideLoading();
          
          // Handle play button click
          playButton.onclick = () => {
            userInteracted = true;
            video.play()
              .then(() => {
                playButton.style.display = 'none';
                showMessage('Stream started');
                // Notify parent window
                try {
                  window.parent.postMessage('videoPlaying', '*');
                } catch (e) {
                  console.error('Error sending message to parent:', e);
                }
              })
              .catch(e => {
                console.error('Error playing video:', e);
                showError('Browser blocked autoplay. Please tap again to play.');
              });
          };
          
          // Auto-play if user has interacted
          if (userInteracted) {
            video.play()
              .then(() => {
                playButton.style.display = 'none';
                // Notify parent window
                try {
                  window.parent.postMessage('videoPlaying', '*');
                } catch (e) {
                  console.error('Error sending message to parent:', e);
                }
              })
              .catch(e => {
                console.error('Error playing video:', e);
                // Show play button if autoplay fails
                playButton.style.display = 'flex';
              });
          }
        });
        
        hlsInstance.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            console.error('HLS error:', data);
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                showError('Network error. Trying another source...');
                setTimeout(tryNextSource, 1000);
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                showError('Media error. Trying to recover...');
                hlsInstance.recoverMediaError();
                break;
              default:
                showError('Stream error. Trying another source...');
                setTimeout(tryNextSource, 1000);
                break;
            }
          }
        });
      } else {
        // Direct source for non-HLS streams
        video.src = url;
        
        video.addEventListener('loadeddata', () => {
          hideLoading();
          playButton.style.display = 'flex';
          
          // Notify parent window
          try {
            window.parent.postMessage('videoPlaying', '*');
          } catch (e) {
            console.error('Error sending message to parent:', e);
          }
        });
        
        video.addEventListener('error', () => {
          console.error('Video error:', video.error);
          showError('Stream error. Trying another source...');
          setTimeout(tryNextSource, 1000);
        });
        
        // Handle play button click
        playButton.onclick = () => {
          userInteracted = true;
          video.play()
            .then(() => {
              playButton.style.display = 'none';
              showMessage('Stream started');
            })
            .catch(e => {
              console.error('Error playing video:', e);
              showError('Browser blocked autoplay. Please tap again to play.');
            });
        };
      }
      
      // Handle video controls
      const playPauseBtn = controls.querySelector('.play-pause');
      const progressBar = controls.querySelector('.progress-bar');
      const progressFill = controls.querySelector('.progress-fill');
      const timeDisplay = controls.querySelector('.time');
      
      playPauseBtn.addEventListener('click', () => {
        if (video.paused) {
          video.play();
          playPauseBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="6" y="4" width="4" height="16"></rect>
              <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
          `;
        } else {
          video.pause();
          playPauseBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
          `;
        }
      });
      
      video.addEventListener('timeupdate', () => {
        const percent = (video.currentTime / video.duration) * 100;
        progressFill.style.width = `${percent}%`;
        
        const minutes = Math.floor(video.currentTime / 60);
        const seconds = Math.floor(video.currentTime % 60);
        timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      });
      
      progressBar.addEventListener('click', (e) => {
        const rect = progressBar.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        video.currentTime = pos * video.duration;
      });
      
      return video;
    }
    
    // Function to load stream
    function loadStream(url) {
      if (!url) {
        showError('No stream URL provided');
        return;
      }
      
      showLoading();
      
      // Determine player type based on URL
      if (url.includes('youtube.com') || url.includes('youtu.be') || url.includes('embed')) {
        createIframePlayer(url);
      } else {
        createVideoPlayer(url);
      }
    }
    
    // Function to try next source
    function tryNextSource() {
      currentSourceIndex = (currentSourceIndex + 1) % sources.length;
      showMessage(`Trying source ${currentSourceIndex + 1}/${sources.length}`);
      loadStream(sources[currentSourceIndex]);
    }
    
    // Function to retry current source
    function retryCurrentSource() {
      // Add new timestamp to force refresh
      const baseUrl = sources[currentSourceIndex].split('?')[0];
      sources[currentSourceIndex] = addTimestamp(baseUrl);
      loadStream(sources[currentSourceIndex]);
    }
    
    // Setup sources
    if (streamUrl) {
      // Create multiple sources from the original URL
      sources = [streamUrl];
      
      // Add timestamp to avoid caching
      sources[0] = addTimestamp(sources[0]);
      
      // Add fallback streams
      sources = [...sources, ...fallbackStreams];
    } else {
      // If no stream URL provided, use fallback streams
      sources = fallbackStreams;
    }
    
    // Event listeners
    retryBtn.addEventListener('click', function() {
      userInteracted = true;
      retryCurrentSource();
    });
    
    nextSourceBtn.addEventListener('click', function() {
      userInteracted = true;
      tryNextSource();
    });
    
    // Start loading the first source
    if (sources.length > 0) {
      loadStream(sources[currentSourceIndex]);
    } else {
      showError('No stream URL provided');
    }
    
    // Listen for messages from parent window
    window.addEventListener('message', function(event) {
      if (event.data === 'toggleMute' && currentPlayer && currentPlayer.tagName === 'VIDEO') {
        currentPlayer.muted = !currentPlayer.muted;
        showMessage(currentPlayer.muted ? 'Muted' : 'Unmuted');
      }
    });
    
    // Handle clicks on the player to play/pause
    playerContainer.addEventListener('click', function(e) {
      // Don't handle clicks on buttons or controls
      if (e.target.tagName === 'BUTTON' || 
          e.target.closest('.error-container') ||
          e.target.closest('.controls') ||
          e.target === playButton) {
        return;
      }
      
      userInteracted = true;
      
      // If there's an error showing, try again
      if (errorContainer.style.display !== 'none') {
        retryCurrentSource();
        return;
      }
      
      // Toggle play/pause if it's a video
      if (currentPlayer && currentPlayer.tagName === 'VIDEO') {
        if (currentPlayer.paused) {
          currentPlayer.play();
          playButton.style.display = 'none';
        } else {
          currentPlayer.pause();
          playButton.style.display = 'flex';
        }
      }
    });
    
    // Handle user interaction to enable autoplay
    document.addEventListener('click', function() {
      userInteracted = true;
    });
    
    document.addEventListener('touchstart', function() {
      userInteracted = true;
    });
  </script>
</body>
</html>